---
import hafsData from "../data/hafs.json";
import BaseLayout from "../layouts/BaseLayout.astro";
import FloatingControls from "../components/FloatingControls.astro";
import Ayah from "../components/Ayah.astro";
import SurahName from "../components/SurahName.astro";
import AyahTranslation from "../components/AyahTranslation.astro";
import Bismillah from "../components/Bismillah.astro";

export const prerender = true;
export async function getStaticPaths() {
  const surahs = [...new Set(hafsData.map((item) => item.sura_no))];
  return surahs.map((surah) => ({
    params: { surah: surah.toString() },
  }));
}
const { surah } = Astro.params;

if (!surah) {
  return Astro.redirect("/");
}

const surahNumber = parseInt(surah);
const ayahs = hafsData
  .filter((aya) => aya.sura_no === surahNumber)
  .sort((a, b) => a.aya_no - b.aya_no);

if (ayahs.length === 0) {
  return Astro.redirect("/");
}

const surahName = ayahs[0]?.sura_name_en || "";
---

<BaseLayout title={surahName}>
  <a
    href={`/#${surahNumber}`}
    class="text-md mb-4 inline-block font-serif text-black no-underline hover:underline dark:text-white"
    >‚Üê Back to Home</a
  >
  <h1 class="mt-8 mb-16 font-serif text-3xl">
    {surahName} (<SurahName surah={surahNumber} />)
  </h1>
  <Bismillah surahNumber={surahNumber} />
  <div class="pb-24">
    {
      ayahs.map((aya) => (
        <div id={aya.aya_no.toString()}>
          <hr class="my-4 border-t border-neutral-300 dark:border-neutral-600" />
          <a
            href={`#${aya.aya_no}`}
            class="mb-4 block font-serif text-lg text-neutral-500 dark:text-neutral-400"
          >
            {aya.sura_no}:{aya.aya_no}
          </a>
          <Ayah surah={surahNumber} ayah={aya.aya_no} />
          <AyahTranslation
            surah={surahNumber}
            ayah={aya.aya_no}
            language="en"
            translation_id="saheeh"
          />
        </div>
      ))
    }
  </div>
  <FloatingControls />
  <script>
    // Keyboard navigation for ayahs
    const ayahElements = Array.from(document.querySelectorAll("[id]")).filter(
      (el) => /^\d+$/.test(el.id),
    );

    let currentAyahIndex = 0;

    // Track current ayah using hash or first ayah
    const currentHash = window.location.hash.slice(1);
    if (currentHash) {
      const index = ayahElements.findIndex((el) => el.id === currentHash);
      if (index !== -1) currentAyahIndex = index;
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") {
        // Next ayah
        if (currentAyahIndex < ayahElements.length - 1) {
          currentAyahIndex++;
          const nextAyah = ayahElements[currentAyahIndex];
          nextAyah.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
          history.replaceState(null, "", "#" + nextAyah.id);
        }
      } else if (e.key === "ArrowLeft") {
        // Previous ayah
        if (currentAyahIndex > 0) {
          currentAyahIndex--;
          const prevAyah = ayahElements[currentAyahIndex];
          prevAyah.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
          history.replaceState(null, "", "#" + prevAyah.id);
        }
      }
    });
  </script>
</BaseLayout>
