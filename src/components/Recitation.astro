---
export interface Props {
  reciter: string;
  surahNumber: number;
}

const { reciter, surahNumber } = Astro.props;
---

<div
  id="recitation-bar"
  data-reciter={reciter}
  data-surah-number={surahNumber}
  class="fixed right-0 bottom-0 left-0 z-40 flex flex-wrap items-center justify-center gap-2 md:gap-4 border-t border-neutral-300 bg-white p-4 dark:border-neutral-600 dark:bg-black"
>
  <audio id="recitation-audio" preload="metadata"></audio>

  <button
    id="play-pause-btn"
      class="relative flex h-10 w-10 md:h-12 md:w-12 items-center justify-center rounded-full bg-black text-white transition-colors hover:bg-neutral-700 dark:bg-white dark:text-black dark:hover:bg-neutral-300"
    aria-label="Play/Pause"
  >
    <span id="play-icon" class="relative z-10"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M320-200v-560l440 280-440 280Z"/></svg></span>
    <svg
      id="play-spinner"
      class="absolute top-1/2 left-1/2 hidden h-4 w-4 md:h-5 md:w-5 -translate-x-1/2 -translate-y-1/2 transform animate-spin text-white dark:text-black"
      viewBox="0 0 24 24"
    >
      <path
        class="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      ></path>
    </svg>
  </button>

  <div class="max-w-md flex-1">
    <input
      id="progress-bar"
      type="range"
      min="0"
      max="100"
      value="0"
      class="h-2 w-full cursor-pointer appearance-none rounded-lg bg-neutral-200 dark:bg-neutral-700"
    />
    <div
      class="mt-1 flex justify-between text-sm text-neutral-600 dark:text-neutral-400"
    >
      <span id="current-time">0:00</span>
      <span id="duration">0:00</span>
    </div>
  </div>

  <div class="flex items-center gap-2">
    <button
      id="skip-back"
      class="flex h-10 w-10 md:h-10 md:w-12 items-center justify-center rounded bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
      aria-label="Skip back 10s"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M860-240 500-480l360-240v480Zm-400 0L100-480l360-240v480Z"/></svg></button
    >
    <button
      id="skip-forward"
      class="flex h-10 w-10 md:h-10 md:w-12 items-center justify-center rounded bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
      aria-label="Skip forward 10s"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="currentColor"><path d="M100-240v-480l360 240-360 240Zm400 0v-480l360 240-360 240Z"/></svg></button
    >
  </div>

  <div class="hidden md:flex items-center gap-2">
    <button
      id="mute-btn"
      class="flex h-10 w-10 md:h-10 md:w-12 items-center justify-center rounded bg-neutral-200 hover:bg-neutral-300 dark:bg-neutral-700 dark:hover:bg-neutral-600"
      aria-label="Mute/Unmute"><svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="currentColor"><path d="M560-131v-82q90-26 145-100t55-168q0-94-55-168T560-749v-82q124 28 202 125.5T840-481q0 127-78 224.5T560-131ZM120-360v-240h160l200-200v640L280-360H120Zm440 40v-322q47 22 73.5 66t26.5 96q0 51-26.5 94.5T560-320Z"/></svg></button
    >
    <input
      id="volume-slider"
      type="range"
      min="0"
      max="1"
      step="0.1"
      value="1"
      class="h-2 w-20 cursor-pointer appearance-none rounded-lg bg-neutral-200 dark:bg-neutral-700"
    />
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const audio = document.getElementById(
      "recitation-audio",
    ) as HTMLAudioElement;
    const playPauseBtn = document.getElementById(
      "play-pause-btn",
    ) as HTMLButtonElement;
    const playIcon = document.getElementById("play-icon") as HTMLSpanElement;
    const progressBar = document.getElementById(
      "progress-bar",
    ) as HTMLInputElement;
    const currentTimeEl = document.getElementById(
      "current-time",
    ) as HTMLSpanElement;
    const durationEl = document.getElementById("duration") as HTMLSpanElement;
    const skipBackBtn = document.getElementById(
      "skip-back",
    ) as HTMLButtonElement;
    const skipForwardBtn = document.getElementById(
      "skip-forward",
    ) as HTMLButtonElement;
    const muteBtn = document.getElementById("mute-btn") as HTMLButtonElement;
    const volumeSlider = document.getElementById(
      "volume-slider",
    ) as HTMLInputElement;
    const loadingIndicator = document.getElementById(
      "loading-indicator",
    ) as HTMLDivElement;
    const errorMessage = document.getElementById(
      "error-message",
    ) as HTMLDivElement;
    const playSpinner = document.getElementById(
      "play-spinner",
    ) as SVGSVGElement;

    // Read props from data attributes
    const recitationBar = document.getElementById("recitation-bar");
    const reciter = recitationBar.dataset.reciter;
    const surahNumber = parseInt(recitationBar.dataset.surahNumber);

    // Set audio source
    audio.src = `https://download.quranicaudio.com/quran/${reciter}/${surahNumber.toString().padStart(3, "0")}.mp3`;

    // Load saved volume
    const savedVolume = localStorage.getItem("recitation-volume") || "1";
    audio.volume = parseFloat(savedVolume);
    volumeSlider.value = savedVolume;
    let lastVolume = parseFloat(savedVolume);

  // Update mute button
  const updateMuteIcon = () => {
    muteBtn.innerHTML = audio.muted ? '<svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="currentColor"><path d="M792-56 671-177q-25 16-53 27.5T560-131v-82q14-5 27.5-10t25.5-12L480-368v208L280-360H120v-240h128L56-792l56-56 736 736-56 56Zm-8-232-58-58q17-31 25.5-65t8.5-70q0-94-55-168T560-749v-82q124 28 202 125.5T840-481q0 53-14.5 102T784-288ZM650-422l-90-90v-130q47 22 73.5 66t26.5 96q0 15-2.5 29.5T650-422ZM480-592 376-696l104-104v208Z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px" fill="currentColor"><path d="M560-131v-82q90-26 145-100t55-168q0-94-55-168T560-749v-82q124 28 202 125.5T840-481q0 127-78 224.5T560-131ZM120-360v-240h160l200-200v640L280-360H120Zm440 40v-322q47 22 73.5 66t26.5 96q0 51-26.5 94.5T560-320Z"/></svg>';
  };
    updateMuteIcon();

    // Format time
    const formatTime = (seconds: number) => {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, "0")}`;
    };

    // Update progress
    const updateProgress = () => {
      if (audio.duration) {
        progressBar.value = (
          (audio.currentTime / audio.duration) *
          100
        ).toString();
        currentTimeEl.textContent = formatTime(audio.currentTime);
        durationEl.textContent = formatTime(audio.duration);
      }
    };

    // Play/Pause
    playPauseBtn.addEventListener("click", () => {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
    });

    audio.addEventListener("play", () => {
      playIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M560-200v-560h160v560H560Zm-320 0v-560h160v560H240Z"/></svg>';
    });

    audio.addEventListener("pause", () => {
      playIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M320-200v-560l440 280-440 280Z"/></svg>';
    });

    // Progress bar
    progressBar.addEventListener("input", () => {
      const seekTime = (parseFloat(progressBar.value) / 100) * audio.duration;
      audio.currentTime = seekTime;
    });

    audio.addEventListener("timeupdate", updateProgress);
    audio.addEventListener("loadedmetadata", updateProgress);

    // Skip controls
    skipBackBtn.addEventListener("click", () => {
      audio.currentTime = Math.max(0, audio.currentTime - 10);
    });

    skipForwardBtn.addEventListener("click", () => {
      audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
    });

    // Volume
    volumeSlider.addEventListener("input", () => {
      if (audio.muted) {
        audio.muted = false;
        updateMuteIcon();
      }
      audio.volume = parseFloat(volumeSlider.value);
      lastVolume = audio.volume;
      localStorage.setItem("recitation-volume", volumeSlider.value);
    });

    muteBtn.addEventListener("click", () => {
      if (audio.muted) {
        // Unmuting: restore previous volume
        audio.volume = lastVolume;
        volumeSlider.value = lastVolume.toString();
      } else {
        // Muting: store current volume and set to 0
        lastVolume = audio.volume;
        audio.volume = 0;
        volumeSlider.value = "0";
      }
      audio.muted = !audio.muted;
      updateMuteIcon();
    });

    // Loading
    audio.addEventListener("loadstart", () => {
      loadingIndicator.classList.remove("hidden");
      errorMessage.classList.add("hidden");
    });

    audio.addEventListener("canplay", () => {
      loadingIndicator.classList.add("hidden");
    });

    // Error
    audio.addEventListener("error", () => {
      loadingIndicator.classList.add("hidden");
      errorMessage.classList.remove("hidden");
      playPauseBtn.disabled = true;
    });

    // Buffering spinner
    audio.addEventListener("waiting", () => {
      playIcon.classList.add("hidden");
      playSpinner.classList.remove("hidden");
    });

    audio.addEventListener("playing", () => {
      playIcon.classList.remove("hidden");
      playSpinner.classList.add("hidden");
    });
  });
</script>
